{% extends 'base.html' %}

{% block title %}Выборка расходов{% endblock %}

{% block content %}
<div class="container">
    {% if messages %}
    <div class="alert" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}
    <h2>Выборка расходов</h2>
    <form method="get" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: flex-end;">
            <div>
                <label>С даты:</label><br>
                <input type="date" name="start_date" value="{{ start_date|default_if_none:'' }}" style="padding: 5px;">
            </div>
            <div>
                <label>По дату:</label><br>
                <input type="date" name="end_date" value="{{ end_date|default_if_none:'' }}" style="padding: 5px;">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">Фильтровать</button>
            </div>
        </div>
    </form>

    {% if start_date and end_date %}
    <h3 style="color: #2c3e50; margin-bottom: 15px;">Расходы за период с {{ start_date }} по {{ end_date }}</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Категория</th>
                <th>Сумма (€)</th>
                <th>Долг (€)</th>
                <th>Оплачено (€)</th>
                <th>Дата оплаты</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Аренда</td>
                <td>{{ rent.amount|floatformat:2 }}</td>
                <td>{{ rent.debt|floatformat:2 }}</td>
                <td>{{ rent.payment_amount|floatformat:2 }}</td>
                <td>{% if rent.payment_date %}{{ rent.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not rent.paid %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="rent">Оплатить</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Коммунальные</td>
                <td>{{ utilities.amount|floatformat:2 }}</td>
                <td>{{ utilities.debt|floatformat:2 }}</td>
                <td>{{ utilities.payment_amount|floatformat:2 }}</td>
                <td>{% if utilities.payment_date %}{{ utilities.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not utilities.paid and utilities.amount > 0 %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="utilities">Оплатить</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>Электричество</td>
                <td>{{ electricity.amount|floatformat:2 }}</td>
                <td>{{ electricity.debt|floatformat:2 }}</td>
                <td>{{ electricity.payment_amount|floatformat:2 }}</td>
                <td>{% if electricity.payment_date %}{{ electricity.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not electricity.paid and electricity.amount > 0 %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="electricity">Оплатить</button>
                    {% endif %}
                </td>
            </tr>
            <tr class="total-row">
                <td><strong>Итого</strong></td>
                <td><strong>{{ total|floatformat:2 }}</strong></td>
                <td><strong>{{ total_debt|floatformat:2 }}</strong></td>
                <td></td>
                <td></td>
                <td>
                    {% if not rent.paid or not utilities.paid or not electricity.paid %}
                    <button class="btn btn-primary pay-all-btn" style="margin-left: 10px;">Оплатить всё</button>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>

    <div id="payModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:300px;">
            <span class="modal-close" style="float:right; cursor:pointer;">×</span>
            <h3 id="payModalLabel">Оплата</h3>
            <form method="post" action="" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="category" id="payModalCategory">
                <div class="form-group">
                    <label for="payAmount">Сумма (€)</label>
                    <input type="number" id="payAmount" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="payDate">Дата оплаты</label>
                    <input type="date" id="payDate" name="payment_date" required>
                </div>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="btn btn-primary">Оплатить</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('payModal')">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openPayAllModal() {
            const modal = document.getElementById('payModal');
            const form = modal.querySelector('form');
            form.action = "{% url 'expenses:pay_all_expenses' %}";
            document.getElementById('payModalCategory').value = '';
            document.getElementById('payAmount').value = '';
            document.getElementById('payDate').value = '';
            modal.style.display = 'flex';
        }

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeModal('payModal'));
        });

        document.querySelectorAll('.pay-all-btn').forEach(btn => {
            btn.addEventListener('click', openPayAllModal);
        });

        document.querySelectorAll('.pay-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-category');
                const modal = document.getElementById('payModal');
                const form = modal.querySelector('form');
                form.action = "{% url 'expenses:pay_expense' 'CATEGORY' %}".replace('CATEGORY', category);
                document.getElementById('payModalCategory').value = category;
                document.getElementById('payAmount').value = '';
                document.getElementById('payDate').value = '';
                modal.style.display = 'flex';
            });
        });
    </script>

    <h3 style="color: #2c3e50; margin-top: 40px;">Показания счетчиков</h3>
    {% if meter_readings %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Дата</th>
                <th>Категория</th>
                <th>Значение</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody>
            {% for reading in meter_readings %}
            <tr>
                <td>{{ reading.date|date:"d.m.Y" }}</td>
                <td>
                    {% if reading.category == 'electricity' %}Электричество
                    {% elif reading.category == 'cold_water' %}Холодная вода
                    {% elif reading.category == 'hot_water' %}Горячая вода
                    {% else %}{{ reading.category }}{% endif %}
                </td>
                <td>{{ reading.value }}</td>
                <td>
                    <a href="{% url 'expenses:edit_meter_reading' reading.pk %}" class="btn btn-sm btn-warning">Редактировать</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Показания счетчиков за выбранный период отсутствуют.</p>
    {% endif %}

    {% else %}
    <p>Выберите период для отображения расходов.</p>
    {% endif %}
</div>
{% endblock %}
