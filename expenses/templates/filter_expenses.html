{% extends 'base.html' %}
{% load i18n %}
{% load l10n %}

{% block title %}{% trans "–í—ã–±–æ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤" %}{% endblock %}

{% block content %}
<div class="container">
    {% if messages %}
    <div class="alert" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    <h2>{% trans "–í—ã–±–æ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤" %}</h2>

    <!-- –ö–Ω–æ–ø–∫–∏ –º–µ—Å—è—Ü–µ–≤ -->
    <div class="month-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
        {% for month_date, month_name in month_data %}
            <a href="?month={{ month_date|date:'Y-m-d' }}" class="btn btn-secondary month-btn" style="padding: 10px 20px; border-radius: 5px;">
                {{ month_name }}
            </a>
        {% endfor %}
    </div>
    <a href="{% url 'expenses:export_to_pdf' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="btn btn-outline-secondary" target="_blank">
        üìÑ {% trans "–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF" %}
    </a>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü -->
    <h3 style="color: #2c3e50; margin-bottom: 15px;">
        {% blocktrans with month=month_name year=month_year %}–†–∞—Å—Ö–æ–¥—ã –∑–∞ {{ month }} {{ year }}{% endblocktrans %}
    </h3>
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</th>
                <th>{% trans "–°—É–º–º–∞ (‚Ç¨)" %}</th>
                <th>
                    {% if rent.debt < 0 or utilities.debt < 0 or electricity.debt < 0 %}
                        {% trans "–ü–µ—Ä–µ–ø–ª–∞—Ç–∞" %}
                    {% else %}
                        {% trans "–î–æ–ª–≥" %}
                    {% endif %} (‚Ç¨)
                </th>
                <th>{% trans "–û–ø–ª–∞—á–µ–Ω–æ (‚Ç¨)" %}</th>
                <th>{% trans "–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã" %}</th>
                <th>{% trans "–î–µ–π—Å—Ç–≤–∏—è" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{% trans "–ê—Ä–µ–Ω–¥–∞" %}</td>
                <td>{{ rent.amount|floatformat:2 }}</td>
                <td style="color: {% if rent.debt < 0 %}green{% elif rent.debt == 0 %}green{% else %}red{% endif %}">{{ rent.debt|floatformat:2 }}</td>
                <td>{{ rent.payment_amount|floatformat:2 }}</td>
                <td>{% if rent.payment_date %}{{ rent.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not rent.paid and rent.amount > 0 %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="rent">{% trans "–û–ø–ª–∞—Ç–∏—Ç—å" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>{% trans "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ" %}</td>
                <td>{{ utilities.amount|floatformat:2 }}</td>
                <td style="color: {% if utilities.debt < 0 %}green{% elif utilities.debt == 0 %}green{% else %}red{% endif %}">{{ utilities.debt|floatformat:2 }}</td>
                <td>{{ utilities.payment_amount|floatformat:2 }}</td>
                <td>{% if utilities.payment_date %}{{ utilities.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not utilities.paid and utilities.amount > 0 %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="utilities">{% trans "–û–ø–ª–∞—Ç–∏—Ç—å" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>{% trans "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ" %}</td>
                <td>{{ electricity.amount|floatformat:2 }}</td>
                <td style="color: {% if electricity.debt < 0 %}green{% elif electricity.debt == 0 %}green{% else %}red{% endif %}">{{ electricity.debt|floatformat:2 }}</td>
                <td>{{ electricity.payment_amount|floatformat:2 }}</td>
                <td>{% if electricity.payment_date %}{{ electricity.payment_date|date:"d.m.Y" }}{% else %}-{% endif %}</td>
                <td>
                    {% if not electricity.paid and electricity.amount > 0 %}
                    <button class="btn btn-primary btn-small pay-btn" data-category="electricity">{% trans "–û–ø–ª–∞—Ç–∏—Ç—å" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr class="total-row">
                <td><strong>{% trans "–ò—Ç–æ–≥–æ" %}</strong></td>
                <td><strong>{{ total|floatformat:2 }}</strong></td>
                <td style="color: {% if total_debt < 0 %}green{% elif total_debt == 0 %}green{% else %}red{% endif %}"><strong>{{ total_debt|floatformat:2 }}</strong></td>
                <td><strong>{{ total_payment|floatformat:2 }}</strong></td>
                <td></td>
                <td>
                    {% if not rent.paid or not utilities.paid or not electricity.paid %}
                    <button class="btn btn-primary pay-all-btn" style="margin-left: 10px;">{% trans "–û–ø–ª–∞—Ç–∏—Ç—å –≤—Å—ë" %}</button>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü -->
    <h3 style="color: #2c3e50; margin-top: 40px;">
        {% blocktrans with month=current_month|date:"F" year=current_month|date:"Y" %}–ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞ {{ month }} {{ year }}{% endblocktrans %}
    </h3>
    {% if meter_readings %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>{% trans "–î–∞—Ç–∞" %}</th>
                <th>{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</th>
                <th>{% trans "–ó–Ω–∞—á–µ–Ω–∏–µ" %}</th>
                <th>{% trans "–î–µ–π—Å—Ç–≤–∏–µ" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for reading in meter_readings %}
            <tr>
                <td>{{ reading.date|date:"d.m.Y" }}</td>
                <td>
                    {% if reading.category == 'electricity' %}
                        {% trans "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ" %}
                    {% elif reading.category == 'cold_water' %}
                        {% trans "–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞" %}
                    {% elif reading.category == 'hot_water' %}
                        {% trans "–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞" %}
                    {% else %}
                        {{ reading.category }}
                    {% endif %}
                </td>
                <td>{{ reading.value|floatformat:2 }}</td>
                <td>
                    <a href="{% url 'expenses:edit_meter_reading' reading.pk %}" class="btn btn-sm btn-warning">{% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" %}</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>{% trans "–ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç." %}</p>
    {% endif %}

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É -->
    <h3 style="color: #2c3e50; margin-top: 40px;">{% trans "–í—ã–±–æ—Ä–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥:" %}</h3>
    <form method="get" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 15px; align-items: flex-end;">
            <div>
                <label>{% trans "–° –º–µ—Å—è—Ü–∞:" %}</label><br>
                <input type="month" name="start_date" value="{% if start_month %}{{ start_month|date:'Y-m' }}{% endif %}" style="padding: 5px;">
            </div>
            <div>
                <label>{% trans "–ü–æ –º–µ—Å—è—Ü:" %}</label><br>
                <input type="month" name="end_date" value="{% if end_month %}{{ end_month|date:'Y-m' }}{% endif %}" style="padding: 5px;">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">{% trans "–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å" %}</button>
            </div>
        </div>
    </form>

    {% if start_month and end_month %}
    <h3 style="color: #2c3e50; margin-bottom: 15px;">
         {% trans "–†–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å" %} {{ start_formatted }} {% trans "–ø–æ" %} {{ end_formatted }}
    </h3>
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</th>
                <th>{% trans "–°—É–º–º–∞ (‚Ç¨)" %}</th>
                <th>
                    {% if period_total.rent.debt < 0 or period_total.utilities.debt < 0 or period_total.electricity.debt < 0 %}
                        {% trans "–ü–µ—Ä–µ–ø–ª–∞—Ç–∞" %}
                    {% else %}
                        {% trans "–î–æ–ª–≥" %}
                    {% endif %} (‚Ç¨)
                </th>
                <th>{% trans "–û–ø–ª–∞—á–µ–Ω–æ (‚Ç¨)" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{% trans "–ê—Ä–µ–Ω–¥–∞" %}</td>
                <td>{{ period_total.rent.amount|floatformat:2 }}</td>
                <td style="color: {% if period_total.rent.debt < 0 %}green{% elif period_total.rent.debt == 0 %}green{% else %}red{% endif %}">{{ period_total.rent.debt|floatformat:2 }}</td>
                <td>{{ period_total.rent.payment_amount|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ" %}</td>
                <td>{{ period_total.utilities.amount|floatformat:2 }}</td>
                <td style="color: {% if period_total.utilities.debt < 0 %}green{% elif period_total.utilities.debt == 0 %}green{% else %}red{% endif %}">{{ period_total.utilities.debt|floatformat:2 }}</td>
                <td>{{ period_total.utilities.payment_amount|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ" %}</td>
                <td>{{ period_total.electricity.amount|floatformat:2 }}</td>
                <td style="color: {% if period_total.electricity.debt < 0 %}green{% elif period_total.electricity.debt == 0 %}green{% else %}red{% endif %}">{{ period_total.electricity.debt|floatformat:2 }}</td>
                <td>{{ period_total.electricity.payment_amount|floatformat:2 }}</td>
            </tr>
            <tr class="total-row">
                <td><strong>{% trans "–ò—Ç–æ–≥–æ" %}</strong></td>
                <td><strong>{{ period_total.total|floatformat:2 }}</strong></td>
                <td style="color: {% if period_total.total_debt < 0 %}green{% elif period_total.total_debt == 0 %}green{% else %}red{% endif %}"><strong>{{ period_total.total_debt|floatformat:2 }}</strong></td>
                <td><strong>{{ period_total.total_payment|floatformat:2 }}</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- –ü–æ–∫–∞–∑–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –≤–æ–¥—ã –∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
    <h3 style="color: #2c3e50; margin-top: 40px;">{% trans "–ü–æ–∫–∞–∑–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –≤–æ–¥—ã –∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥" %}</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</th>
                <th>{% trans "–°—É–º–º–∞—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥" %}</th>
                <th>{% trans "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥" %}</th>
                <th>{% trans "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥" %}</th>
                <th>{% trans "–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{% trans "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ" %}</td>
                <td>{{ meter_usage.electricity.total|floatformat:2 }}</td>
                <td>{{ meter_usage.electricity.min|floatformat:2 }}</td>
                <td>{{ meter_usage.electricity.max|floatformat:2 }}</td>
                <td>{{ meter_usage.electricity.avg|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞" %}</td>
                <td>{{ meter_usage.cold_water.total|floatformat:2 }}</td>
                <td>{{ meter_usage.cold_water.min|floatformat:2 }}</td>
                <td>{{ meter_usage.cold_water.max|floatformat:2 }}</td>
                <td>{{ meter_usage.cold_water.avg|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞" %}</td>
                <td>{{ meter_usage.hot_water.total|floatformat:2 }}</td>
                <td>{{ meter_usage.hot_water.min|floatformat:2 }}</td>
                <td>{{ meter_usage.hot_water.max|floatformat:2 }}</td>
                <td>{{ meter_usage.hot_water.avg|floatformat:2 }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="payModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div class="modal-content" style="background:white; padding:20px; border-radius:8px; width:300px;">
            <span class="modal-close" style="float:right; cursor:pointer;">√ó</span>
            <h3 id="payModalLabel">{% trans "–û–ø–ª–∞—Ç–∞" %}</h3>
            <form method="post" action="" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="category" id="payModalCategory">
                <div class="form-group">
                    <label for="payAmount">{% trans "–°—É–º–º–∞ (‚Ç¨)" %}</label>
                    <input type="number" id="payAmount" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="payDate">{% trans "–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã" %}</label>
                    <input type="date" id="payDate" name="payment_date" required>
                </div>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="btn btn-primary">{% trans "–û–ø–ª–∞—Ç–∏—Ç—å" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('payModal')">{% trans "–û—Ç–º–µ–Ω–∞" %}</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openPayAllModal() {
            const modal = document.getElementById('payModal');
            const form = modal.querySelector('form');
            form.action = "{% url 'expenses:pay_all_expenses' %}";
            document.getElementById('payModalCategory').value = '';
            document.getElementById('payAmount').value = '';
            document.getElementById('payDate').value = '';
            modal.style.display = 'flex';
        }

        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => closeModal('payModal'));
        });

        document.querySelectorAll('.pay-all-btn').forEach(btn => {
            btn.addEventListener('click', openPayAllModal);
        });

        document.querySelectorAll('.pay-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-category');
                const modal = document.getElementById('payModal');
                const form = modal.querySelector('form');
                form.action = "{% url 'expenses:pay_expense' 'CATEGORY' %}".replace('CATEGORY', category);
                document.getElementById('payModalCategory').value = category;
                document.getElementById('payAmount').value = '';
                document.getElementById('payDate').value = '';
                modal.style.display = 'flex';
            });
        });
    </script>
</div>
{% endblock %}