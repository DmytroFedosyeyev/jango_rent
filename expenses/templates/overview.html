{% extends 'base.html' %}
{% load i18n %}

{% block extra_head %}
<style>
    .stat-max {
        color: red;
        font-weight: bold;
    }

    .stat-min {
        color: green;
        font-weight: bold;
    }

    .stat-avg {
        color: blue;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block title %}{% trans "Обзор расходов" %}{% endblock %}

{% block content %}
<div class="container">
    <h2>{% trans "Обзор расходов" %}</h2>
    <p>{% blocktrans %}Текущий месяц: {{ current_month }} {{ current_year }}{% endblocktrans %}</p>

    <h3>{% trans "Расходы по категориям за год" %}</h3>
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "Категория" %}</th>
                <th>{% trans "Сумма (€)" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses_by_category %}
            <tr{% if expense.category == 'total' %} class="total-row"{% endif %}>
                <td>{% if expense.category == 'total' %}<strong>{{ expense.category_display }}</strong>{% else %}{{ expense.category_display }}{% endif %}</td>
                <td>{% if expense.category == 'total' %}<strong>{{ expense.total_amount|floatformat:2 }}</strong>{% else %}{{ expense.total_amount|floatformat:2 }}{% endif %}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2">{% trans "Нет расходов за год" %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>{% trans "Графики потребления" %}</h3>
    <div style="margin-bottom: 20px;">
        <h4>{% trans "Расход электроэнергии (кВт·ч)" %}</h4>
        <canvas id="electricityChart" width="400" height="200"></canvas>
    </div>
    <div>
        <h4>{% trans "Расход воды (м³)" %}</h4>
        <canvas id="waterChart" width="400" height="200"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
    // График электроэнергии
    new Chart(document.getElementById('electricityChart'), {
        type: 'bar',
        data: {
            labels: {{ chart_months|safe }},
            datasets: [{
                label: '{% trans "Электричество (кВт·ч)" %}',
                data: {{ electricity_data|safe }},
                backgroundColor: '#007bff',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: '{% trans "кВт·ч" %}' }
                }
            }
        }
    });

    // График воды
    new Chart(document.getElementById('waterChart'), {
        type: 'line',
        data: {
            labels: {{ chart_months|safe }},
            datasets: [
                {
                    label: '{% trans "Холодная вода (м³)" %}',
                    data: {{ cold_water_data|safe }},
                    borderColor: '#007bff',
                    fill: false
                },
                {
                    label: '{% trans "Горячая вода (м³)" %}',
                    data: {{ hot_water_data|safe }},
                    borderColor: '#dc3545',
                    fill: false
                }
            ]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: '{% trans "м³" %}' }
                }
            }
        }
    });
</script>

<hr>
<h3>{% blocktrans %}Статистика потребления за {{ current_year }}{% endblocktrans %}</h3>

<div class="row">
    <div class="col">
        <h4>{% trans "Электричество (кВт·ч)" %}</h4>
        <ul>
            <li class="stat-max">{% trans "Максимум" %}: {{ electricity_stats.max|floatformat:2 }}</li>
            <li class="stat-min">{% trans "Минимум" %}: {{ electricity_stats.min|floatformat:2 }}</li>
            <li class="stat-avg">{% trans "Среднее" %}: {{ electricity_stats.avg|floatformat:2 }}</li>
        </ul>
    </div>
    <div class="col">
        <h4>{% trans "Холодная вода (м³)" %}</h4>
        <ul>
            <li class="stat-max">{% trans "Максимум" %}: {{ cold_water_stats.max|floatformat:2 }}</li>
            <li class="stat-min">{% trans "Минимум" %}: {{ cold_water_stats.min|floatformat:2 }}</li>
            <li class="stat-avg">{% trans "Среднее" %}: {{ cold_water_stats.avg|floatformat:2 }}</li>
        </ul>
    </div>
    <div class="col">
        <h4>{% trans "Горячая вода (м³)" %}</h4>
        <ul>
            <li class="stat-max">{% trans "Максимум" %}: {{ hot_water_stats.max|floatformat:2 }}</li>
            <li class="stat-min">{% trans "Минимум" %}: {{ hot_water_stats.min|floatformat:2 }}</li>
            <li class="stat-avg">{% trans "Среднее" %}: {{ hot_water_stats.avg|floatformat:2 }}</li>
        </ul>
    </div>
</div>

{% endblock %}