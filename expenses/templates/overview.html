{% extends 'base.html' %}
{% load i18n %}

{% block extra_head %}
<style>
    .stat-max { color: red; font-weight: bold; }
    .stat-min { color: green; font-weight: bold; }
    .stat-avg { color: blue; font-weight: bold; }
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin-bottom: 2rem;
    }
    .chart-container canvas {
        width: 100% !important;
        height: 100% !important;
    }
</style>
{% endblock %}

{% block title %}{% trans "Обзор расходов" %}{% endblock %}

{% block content %}
<div class="container">
    <h2>{% trans "Обзор расходов" %}</h2>
    <p>{% blocktrans %}Текущий месяц: {{ current_month }} {{ current_year }}{% endblocktrans %}</p>

    <h3>{% trans "Расходы по категориям за год" %}</h3>
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "Категория" %}</th>
                <th>{% trans "Сумма (€)" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses_by_category %}
            <tr{% if expense.category == 'total' %} class="total-row"{% endif %}>
                <td>{{ expense.category_display }}</td>
                <td>{{ expense.total_amount|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>{% trans "Графики потребления" %}</h3>
    <div class="chart-container">
        <h4>{% trans "Расход электроэнергии (кВт·ч)" %}</h4>
        <canvas id="electricityChart"></canvas>
    </div>
    <div class="chart-container">
        <h4>{% trans "Расход воды (м³)" %}</h4>
        <canvas id="waterChart"></canvas>
    </div>

    <!-- Отладочный вывод -->
    <div style="margin-bottom: 20px;">
        <p><strong>Debug:</strong> chart_months = {{ chart_months|safe }}</p>
        <p><strong>Debug:</strong> electricity_months = {{ electricity_months|safe }}</p>
        <p><strong>Debug:</strong> electricity_values = {{ electricity_values|safe }}</p>
        <p><strong>Debug:</strong> cold_water_months = {{ cold_water_months|safe }}</p>
        <p><strong>Debug:</strong> cold_water_values = {{ cold_water_values|safe }}</p>
        <p><strong>Debug:</strong> hot_water_months = {{ hot_water_months|safe }}</p>
        <p><strong>Debug:</strong> hot_water_values = {{ hot_water_values|safe }}</p>
    </div>

    <hr>
    <h3>{% blocktrans %}Статистика потребления за {{ current_year }}{% endblocktrans %}</h3>
    <div class="row">
        <div class="col">
            <h4>{% trans "Электричество (кВт·ч)" %}</h4>
            <ul>
                <li class="stat-max">{% trans "Максимум" %}: {{ electricity_stats.max|floatformat:2 }}</li>
                <li class="stat-min">{% trans "Минимум" %}: {{ electricity_stats.min|floatformat:2 }}</li>
                <li class="stat-avg">{% trans "Среднее" %}: {{ electricity_stats.avg|floatformat:2 }}</li>
            </ul>
        </div>
        <div class="col">
            <h4>{% trans "Холодная вода (м³)" %}</h4>
            <ul>
                <li class="stat-max">{% trans "Максимум" %}: {{ cold_water_stats.max|floatformat:2 }}</li>
                <li class="stat-min">{% trans "Минимум" %}: {{ cold_water_stats.min|floatformat:2 }}</li>
                <li class="stat-avg">{% trans "Среднее" %}: {{ cold_water_stats.avg|floatformat:2 }}</li>
            </ul>
        </div>
        <div class="col">
            <h4>{% trans "Горячая вода (м³)" %}</h4>
            <ul>
                <li class="stat-max">{% trans "Максимум" %}: {{ hot_water_stats.max|floatformat:2 }}</li>
                <li class="stat-min">{% trans "Минимум" %}: {{ hot_water_stats.min|floatformat:2 }}</li>
                <li class="stat-avg">{% trans "Среднее" %}: {{ hot_water_stats.avg|floatformat:2 }}</li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const months = {{ chart_months|safe }};
    const electricityMonths = {{ electricity_months|safe }};
    const electricityValues = {{ electricity_values|safe }};
    const coldWaterMonths = {{ cold_water_months|safe }};
    const coldWaterValues = {{ cold_water_values|safe }};
    const hotWaterMonths = {{ hot_water_months|safe }};
    const hotWaterValues = {{ hot_water_values|safe }};

    console.log('chart_months:', months);
    console.log('electricity:', { months: electricityMonths, values: electricityValues });
    console.log('cold_water:', { months: coldWaterMonths, values: coldWaterValues });
    console.log('hot_water:', { months: hotWaterMonths, values: hotWaterValues });

    // Электричество
    new Chart(document.getElementById('electricityChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: '{% trans "Электричество (кВт·ч)" %}',
                data: months.map(month => electricityMonths.includes(month) ? electricityValues[electricityMonths.indexOf(month)] : null),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.3,
                fill: false,
                pointRadius: 5,
                spanGaps: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 200,
                    title: { display: true, text: '{% trans "кВт·ч" %}' }
                },
                x: {
                    title: { display: true, text: '{% trans "Месяц" %}' }
                }
            }
        }
    });

    // Вода
    new Chart(document.getElementById('waterChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: '{% trans "Холодная вода (м³)" %}',
                    data: months.map(month => coldWaterMonths.includes(month) ? coldWaterValues[coldWaterMonths.indexOf(month)] : null),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 5,
                    spanGaps: false
                },
                {
                    label: '{% trans "Горячая вода (м³)" %}',
                    data: months.map(month => hotWaterMonths.includes(month) ? hotWaterValues[hotWaterMonths.indexOf(month)] : null),
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 5,
                    spanGaps: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    title: { display: true, text: '{% trans "м³" %}' }
                },
                x: {
                    title: { display: true, text: '{% trans "Месяц" %}' }
                }
            }
        }
    });
});
</script>
{% endblock %}