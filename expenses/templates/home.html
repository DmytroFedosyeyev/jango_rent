{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Главная" %}{% endblock %}

{% block content %}
<div class="container">
    <h2>{% blocktrans %}Расходы за {{ current_month }} {{ current_year }}{% endblocktrans %}</h2>

    <!-- Таблица расходов текущего месяца -->
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "Категория" %}</th>
                <th>{% trans "Сумма (€)" %}</th>
                <th>{% trans "Оплачено (€)" %}</th>
                <th>{% trans "Дата оплаты" %}</th>
                <th>{% trans "Статус" %}</th>
                <th>{% trans "Действия" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{% trans "Аренда" %}</td>
                <td>{{ rent.amount|floatformat:2 }}</td>
                <td>{{ rent.payment_amount|floatformat:2 }}</td>
                <td>
                    {% if rent.payment_date %}
                        {{ rent.payment_date|date:"d.m.Y" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if rent.paid %}
                        <span class="status status-paid">{% trans "Оплачено" %}</span>
                    {% else %}
                        <span class="status status-unpaid">{% trans "Ожидает оплаты" %}</span>
                    {% endif %}
                </td>
                <td>
                    {% if rent.amount == 0 %}
                        <button class="btn btn-primary btn-sm add-expense-btn" data-category="rent">{% trans "Ввести данные" %}</button>
                    {% endif %}
                    {% if rent.amount > 0 and not rent.paid %}
                        <button class="btn btn-primary btn-sm pay-btn" data-target="payModal" data-category="rent">{% trans "Оплатить" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>{% trans "Коммунальные" %}</td>
                <td>{{ utilities.amount|floatformat:2 }}</td>
                <td>{{ utilities.payment_amount|floatformat:2 }}</td>
                <td>
                    {% if utilities.payment_date %}
                        {{ utilities.payment_date|date:"d.m.Y" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if utilities.paid %}
                        <span class="status status-paid">{% trans "Оплачено" %}</span>
                    {% else %}
                        <span class="status status-unpaid">{% trans "Ожидает оплаты" %}</span>
                    {% endif %}
                </td>
                <td>
                    {% if utilities.amount == 0 %}
                        <button class="btn btn-primary btn-sm add-expense-btn" data-category="utilities">{% trans "Ввести данные" %}</button>
                    {% endif %}
                    {% if utilities.amount > 0 and not utilities.paid %}
                        <button class="btn btn-primary btn-sm pay-btn" data-target="payModal" data-category="utilities">{% trans "Оплатить" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>{% trans "Электричество" %}</td>
                <td>{{ electricity.amount|floatformat:2 }}</td>
                <td>{{ electricity.payment_amount|floatformat:2 }}</td>
                <td>
                    {% if electricity.payment_date %}
                        {{ electricity.payment_date|date:"d.m.Y" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if electricity.paid %}
                        <span class="status status-paid">{% trans "Оплачено" %}</span>
                    {% else %}
                        <span class="status status-unpaid">{% trans "Ожидает оплаты" %}</span>
                    {% endif %}
                </td>
                <td>
                    {% if electricity.amount == 0 %}
                        <button class="btn btn-primary btn-sm add-expense-btn" data-category="electricity">{% trans "Ввести данные" %}</button>
                    {% endif %}
                    {% if electricity.amount > 0 and not electricity.paid %}
                        <button class="btn btn-primary btn-sm pay-btn" data-target="payModal" data-category="electricity">{% trans "Оплатить" %}</button>
                    {% endif %}
                </td>
            </tr>
            <tr class="total-row">
                <td><strong>{% trans "Итого" %}</strong></td>
                <td><strong>{{ total|floatformat:2 }}</strong></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    {% if not rent.paid or not utilities.paid or not electricity.paid %}
                    <button class="btn btn-primary pay-all-btn" data-target="payModal" style="margin-left: 10px;">{% trans "Оплатить всё" %}</button>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Модальное окно для оплаты -->
    <div id="payModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
            <span class="modal-close" style="float: right; cursor: pointer;">×</span>
            <h3 id="payModalLabel">{% trans "Оплата" %}</h3>
            <form method="post" action="" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="category" id="payModalCategory">
                <div class="form-group">
                    <label for="payAmount">{% trans "Сумма (€)" %}</label>
                    <input type="number" id="payAmount" name="amount" step="0.01" required>
                    <div class="invalid-feedback">{% trans "Пожалуйста, введите сумму." %}</div>
                </div>
                <div class="form-group">
                    <label for="payDate">{% trans "Дата оплаты" %}</label>
                    <input type="date" id="payDate" name="payment_date" required>
                    <div class="invalid-feedback">{% trans "Пожалуйста, выберите дату." %}</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">{% trans "Оплатить" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('payModal')">{% trans "Отмена" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно для ввода данных -->
    <div id="addExpenseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
            <span class="modal-close" style="float: right; cursor: pointer;">×</span>
            <h3 id="addExpenseModalLabel">{% trans "Ввод данных" %}</h3>
            <form method="post" action="{% url 'expenses:add_expense_modal' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="category" id="addModalCategory">
                <div class="form-group">
                    <label for="addAmount">{% trans "Сумма (€)" %}</label>
                    <input type="number" id="addAmount" name="amount" step="0.01" required>
                    <div class="invalid-feedback">{% trans "Пожалуйста, введите сумму." %}</div>
                </div>
                <div class="form-group">
                    <label for="addDate">{% trans "Дата" %}</label>
                    <input type="date" id="addDate" name="date" required>
                    <div class="invalid-feedback">{% trans "Пожалуйста, выберите дату." %}</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">{% trans "Сохранить" %}</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addExpenseModal')">{% trans "Отмена" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Таблица долгов на 1-е число -->
    <h3 style="color: #2c3e50; margin-top: 20px;">{% blocktrans %}Долг на 1 {{ current_month }} {{ current_year }}{% endblocktrans %}</h3>
    <table class="table">
        <thead>
            <tr>
                <th>{% trans "Категория" %}</th>
                <th>{% trans "Долг (€)" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{% trans "Аренда" %}</td>
                <td>{{ debt.rent|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "Коммунальные" %}</td>
                <td>{{ debt.utilities|floatformat:2 }}</td>
            </tr>
            <tr>
                <td>{% trans "Электричество" %}</td>
                <td>{{ debt.electricity|floatformat:2 }}</td>
            </tr>
            <tr class="total-row">
                <td><strong>{% trans "Итого" %}</strong></td>
                <td><strong>{{ debt.total|floatformat:2 }}</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- Календарь месяцев -->
    <h3 style="color: #2c3e50; margin-top: 20px;">{% trans "Статус оплаты по месяцам (2025)" %}</h3>
    <div class="month-calendar">
        {% for month in months|slice:":12" %}
            {% if forloop.counter0|divisibleby:4 %}
                {% if forloop.counter0 != 0 %}
                    </div>
                {% endif %}
                <div class="month-row">
            {% endif %}
            <div class="month-box month-{{ month.status }}">
                {% if month.status != 'future' %}
                    <a href="{% url 'expenses:monthly_expenses' current_year month.start_date|date:"n" %}" class="month-link">
                        {{ month.name }}
                    </a>
                {% else %}
                    <span class="month-link">{{ month.name }}</span>
                {% endif %}
            </div>
            {% if forloop.last %}
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if messages %}
    <div class="alert alert-success" role="alert">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- JavaScript для модальных окон -->
<script>
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // Обработка модального окна оплаты
    document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => closeModal('payModal'));
    });

    document.querySelectorAll('.pay-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = document.getElementById('payModal');
            const form = modal.querySelector('form');
            form.action = "{% url 'expenses:pay_all_expenses' %}";
            document.getElementById('payModalCategory').value = '';
            document.getElementById('payAmount').value = '';
            document.getElementById('payDate').value = '';
            modal.style.display = 'flex';
        });
    });

    document.querySelectorAll('.pay-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = document.getElementById('payModal');
            const form = modal.querySelector('form');
            const category = btn.getAttribute('data-category');
            form.action = "{% url 'expenses:pay_expense' 'REPLACE' %}".replace('REPLACE', category);
            document.getElementById('payModalCategory').value = category;
            document.getElementById('payAmount').value = '';
            document.getElementById('payDate').value = '';
            modal.style.display = 'flex';
        });
    });

    window.addEventListener('click', (e) => {
        const modal = document.getElementById('payModal');
        if (e.target === modal) {
            closeModal('payModal');
        }
    });

    // Обработка модального окна ввода данных
    document.querySelectorAll('.add-expense-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = document.getElementById('addExpenseModal');
            const form = modal.querySelector('form');
            const category = this.getAttribute('data-category');
            document.getElementById('addModalCategory').value = category;
            document.getElementById('addExpenseModalLabel').textContent =
                category === 'rent' ? "{% trans 'Ввод данных для Аренды' %}" :
                category === 'utilities' ? "{% trans 'Ввод данных для Коммунальных' %}" :
                "{% trans 'Ввод данных для Электричества' %}";
            document.getElementById('addAmount').value = '';
            document.getElementById('addDate').value = '';
            modal.style.display = 'flex';
        });
    });

    document.querySelectorAll('#addExpenseModal .modal-close').forEach(btn => {
        btn.addEventListener('click', () => closeModal('addExpenseModal'));
    });

    window.addEventListener('click', (e) => {
        const modal = document.getElementById('addExpenseModal');
        if (e.target === modal) {
            closeModal('addExpenseModal');
        }
    });

    // Валидация форм
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}
